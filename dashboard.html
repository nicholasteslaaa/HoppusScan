<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Workspace Control</title>
    <style>
        :root {
            --bg: #0f172a;
            --panel: #1e293b;
            --accent: #22d3ee;
            --danger: #f43f5e;
            --text: #f8fafc;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 { font-weight: 700; letter-spacing: -0.025em; margin-bottom: 2rem; color: var(--accent); }

        /* Main Stream Styling */
        .stream-wrapper {
            position: relative;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.5);
            border: 4px solid var(--panel);
            overflow: hidden;
            line-height: 0;
        }

        #main-feed {
            width: 640px; /* UI Scale (2x the 320px source) */
            height: 480px;
            background: #000;
        }

        #draw-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        /* Grid Layout */
        .roi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1100px;
            margin-top: 30px;
        }

        .roi-card {
            background: var(--panel);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid #334155;
            transition: transform 0.2s, border-color 0.2s;
        }

        .roi-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .roi-card img {
            width: 100%;
            aspect-ratio: 4/3;
            object-fit: cover;
            border-radius: 6px;
            background: #000;
        }

        .roi-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            font-size: 0.85rem;
        }

        .btn-delete {
            width: 100%;
            background: var(--danger);
            color: white;
            border: none;
            padding: 8px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .btn-delete:hover { opacity: 0.8; }

        .hint { margin-top: 15px; color: #94a3b8; font-size: 0.9rem; }
    </style>
</head>
<body onload="syncROIs()">

    <div class="stream-wrapper" id="container">
        <img id="main-feed" src="http://localhost:8000/cam_feed">
        <canvas id="draw-canvas"></canvas>
    </div>
    
    <p class="hint">Draw a rectangle on the feed above to monitor a specific desk.</p>

    <div id="roi-grid" class="roi-grid">
        </div>

    <script>
        const canvas = document.getElementById('draw-canvas');
        const ctx = canvas.getContext('2d');
        const grid = document.getElementById('roi-grid');
        const API = "http://localhost:8000";

        // Scaling (Canvas 640x480 -> Camera 320x240)
        const SCALE = 320 / 640;

        canvas.width = 640;
        canvas.height = 480;

        let drawing = false;
        let startX, startY;

        // 1. Connection Cleanup Logic (Prevents freezing on refresh)
        window.onbeforeunload = () => {
            const imgs = document.getElementsByTagName('img');
            for (let i of imgs) i.src = ""; 
        };

        // 2. Fetch Existing ROIs from Server
        async function syncROIs() {
            try {
                const res = await fetch(`${API}/list_ROIs`);
                const data = await res.json();
                grid.innerHTML = ''; 
                data.rois.forEach((roiStr, idx) => createCard(idx, roiStr));
            } catch (err) { console.error("Sync Error:", err); }
        }

        // 3. Drawing Rectangle Logic
        canvas.onmousedown = (e) => {
            drawing = true;
            startX = e.offsetX;
            startY = e.offsetY;
        };

        canvas.onmousemove = (e) => {
            if (!drawing) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#22d3ee';
            ctx.lineWidth = 3;
            ctx.setLineDash([5, 5]);
            ctx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY);
        };

        canvas.onmouseup = async (e) => {
            if (!drawing) return;
            drawing = false;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const x1 = Math.round(Math.min(startX, e.offsetX) * SCALE);
            const y1 = Math.round(Math.min(startY, e.offsetY) * SCALE);
            const x2 = Math.round(Math.max(startX, e.offsetX) * SCALE);
            const y2 = Math.round(Math.max(startY, e.offsetY) * SCALE);

            const roiStr = `${x1} ${y1} ${x2} ${y2}`;
            
            await fetch(`${API}/add_ROI`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ "ROI": roiStr })
            });
            syncROIs();
        };

        // 4. UI Rendering
        function createCard(idx, roiStr) {
            const card = document.createElement('div');
            card.className = 'roi-card';
            // Added timestamp to URL to force fresh stream connection
            const streamUrl = `${API}/get_ROI?chair_idx=${idx}&nocache=${Date.now()}`;
            
            card.innerHTML = `
                <img src="${streamUrl}">
                <div class="roi-info">
                    <strong>Workspace #${idx + 1}</strong>
                    <span style="color:#64748b; font-family: monospace; font-size:10px;">${roiStr}</span>
                </div>
                <button class="btn-delete" onclick="deleteROI('${roiStr}')">Remove Area</button>
            `;
            grid.appendChild(card);
        }

        async function deleteROI(roiStr) {
            await fetch(`${API}/pop_ROI`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ "ROI": roiStr })
            });
            syncROIs();
        }
    </script>
</body>
</html>